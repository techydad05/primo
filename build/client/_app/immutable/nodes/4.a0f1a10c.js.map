{"version":3,"file":"4.a0f1a10c.js","sources":["../../../../../../src/routes/[site]/+page.svelte"],"sourcesContent":["<script>\n  import {\n    PrimoPage,\n    realtime_subscribe,\n    locked_blocks,\n  } from '@primocms/builder'\n  import { browser } from '$app/environment'\n  import { invalidate } from '$app/navigation'\n  import { createUniqueID } from '$lib/utils'\n\n  export let data\n\n  const { supabase } = data\n\n  const presence_key = createUniqueID()\n  const channel = supabase.channel(`locked-blocks`, {\n    config: { presence: { key: presence_key } },\n  })\n\n  channel.subscribe(async (status) => {\n    if (status === 'SUBSCRIBED') {\n      channel.track({\n        active_block: null,\n      })\n    }\n  })\n\n  channel.on('presence', { event: 'sync' }, () => {\n    const state = channel.presenceState()\n    $locked_blocks = Object.entries(state)\n      .map(([key, value]) => ({\n        key,\n        block_id: value[0]['active_block'],\n        user: value[0]['user'],\n      }))\n      .filter((block) => block.key !== presence_key)\n  })\n\n  realtime_subscribe(async (res) => {\n    channel.track({\n      ...res,\n      presence_key,\n      user: {\n        email: data.user.email,\n      },\n    })\n  })\n\n  if (browser) {\n    supabase\n      .channel('schema-db-changes')\n      .on(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'sections',\n          filter: `page=eq.${data.page.id}`,\n        },\n        () => {\n          invalidate('app:data')\n        }\n      )\n      .subscribe()\n  }\n</script>\n\n<PrimoPage\n  page={{\n    ...data.page,\n    sections: data.sections,\n  }}\n/>\n"],"names":["ctx","data","$$props","supabase","presence_key","createUniqueID","channel","status","state","$locked_blocks","key","value","block","realtime_subscribe","res","invalidate"],"mappings":"mZAqEO,GAAAA,KAAK,KACR,SAAUA,EAAI,CAAA,EAAC,qHADZ,GAAAA,KAAK,KACR,SAAUA,EAAI,CAAA,EAAC,oJA5DN,KAAAC,CAAA,EAAAC,EAEH,KAAA,CAAA,SAAAC,GAAaF,EAEfG,EAAeC,IACfC,EAAUH,EAAS,QAAO,gBAAA,CAC9B,OAAU,CAAA,SAAY,CAAA,IAAKC,CAAY,CAAA,IAGzC,OAAAE,EAAQ,UAAS,MAAQC,GAAM,CACzBA,IAAW,cACbD,EAAQ,MACN,CAAA,aAAc,IAAI,CAAA,IAKxBA,EAAQ,GAAG,WAAc,CAAA,MAAO,MAAM,EAAA,IAAA,OAC9BE,EAAQF,EAAQ,oBACtBG,EAAiB,OAAO,QAAQD,CAAK,EAClC,IAAG,CAAA,CAAGE,EAAKC,CAAK,KAAA,CACf,IAAAD,EACA,SAAUC,EAAM,CAAC,EAAE,aACnB,KAAMA,EAAM,CAAC,EAAE,IAEhB,EAAA,EAAA,OAAQC,GAAUA,EAAM,MAAQR,CAAY,OAGjDS,QAA0BC,GAAG,CAC3BR,EAAQ,MAAK,IACRQ,EACH,aAAAV,EACA,MACE,MAAOH,EAAK,KAAK,KAAK,MAM1BE,EACG,QAAQ,mBAAmB,EAC3B,GACC,oBAEE,MAAO,SACP,OAAQ,SACR,MAAO,WACP,OAAmB,WAAAF,EAAK,KAAK,EAAE,SAG/Bc,EAAW,UAAU,IAGxB,UAAS"}