{"version":3,"file":"6-d8uuc_TM.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/auth/_page.server.js","../../../.svelte-kit/adapter-node/nodes/6.js"],"sourcesContent":["import { r as redirect } from \"../../../chunks/index.js\";\nimport { s as supabase_admin } from \"../../../chunks/admin.js\";\nasync function load({ url, parent }) {\n  const { session } = await parent();\n  const signing_up = url.searchParams.has(\"signup\");\n  const joining_server = url.pathname.includes(\"set-password\");\n  if (!session && !signing_up && !joining_server) {\n    const { data: existing_users } = await supabase_admin.from(\"users\").select(\"*\");\n    const initiated = existing_users?.length > 0;\n    if (!initiated) {\n      throw redirect(303, \"?signup\");\n    }\n  } else if (session && !joining_server) {\n    throw redirect(303, \"/\");\n  }\n}\nconst actions = {\n  sign_in: async ({ request, locals: { supabase } }) => {\n    const data = await request.formData();\n    const email = data.get(\"email\");\n    const password = data.get(\"password\");\n    const { data: res, error } = await supabase.auth.signInWithPassword({ email, password });\n    if (error) {\n      console.error(error);\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n    return {\n      success: true,\n      error: null\n    };\n  },\n  sign_up: async ({ request, locals: { supabase } }) => {\n    const { success, error } = await server_provisioned();\n    if (!success) {\n      return {\n        success: false,\n        error\n      };\n    }\n    const count = await supabase_admin.from(\"users\").select(\"count\").then(({ data: data2 }) => data2?.[0][\"count\"]);\n    if (count > 0) {\n      return {\n        success: false,\n        error: \"Server already initialized. Sign in as the server owner to invite users.\"\n      };\n    }\n    const data = await request.formData();\n    const email = data.get(\"email\");\n    const password = data.get(\"password\");\n    const { data: res, error: auth_error } = await supabase_admin.auth.admin.createUser({\n      // @ts-ignore\n      email,\n      // @ts-ignore\n      password,\n      email_confirm: true\n    });\n    if (auth_error) {\n      return {\n        success: false,\n        error: auth_error.message\n      };\n    } else if (res) {\n      const { error: signin_error } = await supabase.auth.signInWithPassword({ email, password });\n      if (!signin_error) {\n        await supabase_admin.from(\"users\").insert({\n          id: res.user?.id,\n          email: res.user?.email\n        });\n        await supabase_admin.from(\"server_members\").insert({\n          user: res.user?.id,\n          role: \"DEV\",\n          admin: true\n        });\n      }\n      return {\n        success: !signin_error,\n        error: signin_error?.message\n      };\n    }\n  }\n};\nasync function server_provisioned() {\n  const { status, error } = await supabase_admin.from(\"sites\").select();\n  if (status === 0) {\n    return {\n      success: false,\n      error: `Could not connect your Supabase backend. Ensure you've correctly connected your environment variables.`\n    };\n  } else if (status === 404) {\n    console.error(error);\n    return {\n      success: false,\n      error: `Your Supabase backend is connected but incorrectly provisioned. Ensure you've run the setup schema outlined in the Docs.`\n    };\n  } else if (status === 200) {\n    return { success: true, error: null };\n  } else {\n    return { success: false, error: `Unknown error` };\n  }\n}\nexport {\n  actions,\n  load\n};\n//# sourceMappingURL=_page.server.js.map\n","import * as server from '../entries/pages/auth/_page.server.js';\n\nexport const index = 6;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/auth/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/auth/+page.server.js\";\nexport const imports = [\"_app/immutable/nodes/6.6a7c3e39.js\",\"_app/immutable/chunks/index.7ce6af5d.js\",\"_app/immutable/chunks/stores.fb720b2c.js\",\"_app/immutable/chunks/singletons.d2d14c82.js\",\"_app/immutable/chunks/index.ffa02d79.js\",\"_app/immutable/chunks/parse.bee59afc.js\",\"_app/immutable/chunks/navigation.2516ba35.js\",\"_app/immutable/chunks/ServerLogo.34fd066a.js\"];\nexport const stylesheets = [\"_app/immutable/assets/6.7665ad40.css\",\"_app/immutable/assets/ServerLogo.db5c2054.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}