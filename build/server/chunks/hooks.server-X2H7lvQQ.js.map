{"version":3,"file":"hooks.server-X2H7lvQQ.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import \"./index4.js\";\nimport { s as supabase_admin } from \"./admin.js\";\nimport { createSupabaseServerClient } from \"@supabase/auth-helpers-sveltekit\";\nimport { P as PUBLIC_SUPABASE_URL, a as PUBLIC_SUPABASE_PUBLIC_KEY } from \"./public.js\";\nasync function handle({ resolve, event }) {\n  event.locals.supabase = createSupabaseServerClient({\n    supabaseUrl: PUBLIC_SUPABASE_URL,\n    supabaseKey: PUBLIC_SUPABASE_PUBLIC_KEY,\n    event\n  });\n  event.locals.getSession = async () => {\n    const {\n      data: { session }\n    } = await event.locals.supabase.auth.getSession();\n    return session;\n  };\n  const response = await resolve(event, {\n    filterSerializedResponseHeaders(name) {\n      return name === \"content-range\";\n    }\n  });\n  const is_preview = event.url.searchParams.has(\"preview\");\n  if (is_preview) {\n    const [{ data: site }, { data: page }] = await Promise.all([\n      supabase_admin.from(\"sites\").select(\"id, url\").eq(\"url\", event.params.site).single(),\n      supabase_admin.from(\"pages\").select(\"id, url, site!inner(*)\").match({\n        url: event.params.page || \"index\",\n        \"site.url\": event.params.site\n      }).single()\n    ]);\n    if (!site || !page)\n      return new Response(\"no page found\");\n    const { data: file } = await supabase_admin.storage.from(\"sites\").download(`${site.id}/${page.id}/index.html`);\n    return new Response(file || \"no preview found\", {\n      headers: {\n        \"Content-Type\": \"text/html;charset=UTF-8\",\n        \"Access-Control-Allow-Origin\": \"*\"\n      }\n    });\n  }\n  if (event.request.method === \"OPTIONS\") {\n    return new Response(null, {\n      headers: {\n        \"Access-Control-Allow-Methods\": \"POST, GET, OPTIONS, DELETE\",\n        \"Access-Control-Allow-Origin\": \"*\"\n      }\n    });\n  }\n  response.headers.set(\"Access-Control-Allow-Origin\", \"*\");\n  return response;\n}\nexport {\n  handle\n};\n//# sourceMappingURL=hooks.server.js.map\n"],"names":[],"mappings":";;;;;;AAIA,eAAe,MAAM,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,EAAE;AAC1C,EAAE,KAAK,CAAC,MAAM,CAAC,QAAQ,GAAG,0BAA0B,CAAC;AACrD,IAAI,WAAW,EAAE,mBAAmB;AACpC,IAAI,WAAW,EAAE,0BAA0B;AAC3C,IAAI;AACJ,GAAG,CAAC;AACJ,EAAE,KAAK,CAAC,MAAM,CAAC,UAAU,GAAG,YAAY;AACxC,IAAI,MAAM;AACV,MAAM,IAAI,EAAE,EAAE,OAAO;AACrB,KAAK,GAAG,MAAM,KAAK,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,EAAE;AACrD,IAAI,OAAO,OAAO;AAClB,GAAG;AACH,EAAE,MAAM,QAAQ,GAAG,MAAM,OAAO,CAAC,KAAK,EAAE;AACxC,IAAI,+BAA+B,CAAC,IAAI,EAAE;AAC1C,MAAM,OAAO,IAAI,KAAK,eAAe;AACrC;AACA,GAAG,CAAC;AACJ,EAAE,MAAM,UAAU,GAAG,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,SAAS,CAAC;AAC1D,EAAE,IAAI,UAAU,EAAE;AAClB,IAAI,MAAM,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;AAC/D,MAAM,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,KAAK,EAAE,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE;AAC1F,MAAM,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,wBAAwB,CAAC,CAAC,KAAK,CAAC;AAC1E,QAAQ,GAAG,EAAE,KAAK,CAAC,MAAM,CAAC,IAAI,IAAI,OAAO;AACzC,QAAQ,UAAU,EAAE,KAAK,CAAC,MAAM,CAAC;AACjC,OAAO,CAAC,CAAC,MAAM;AACf,KAAK,CAAC;AACN,IAAI,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI;AACtB,MAAM,OAAO,IAAI,QAAQ,CAAC,eAAe,CAAC;AAC1C,IAAI,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,MAAM,cAAc,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,IAAI,CAAC,EAAE,CAAC,WAAW,CAAC,CAAC;AAClH,IAAI,OAAO,IAAI,QAAQ,CAAC,IAAI,IAAI,kBAAkB,EAAE;AACpD,MAAM,OAAO,EAAE;AACf,QAAQ,cAAc,EAAE,yBAAyB;AACjD,QAAQ,6BAA6B,EAAE;AACvC;AACA,KAAK,CAAC;AACN;AACA,EAAE,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,KAAK,SAAS,EAAE;AAC1C,IAAI,OAAO,IAAI,QAAQ,CAAC,IAAI,EAAE;AAC9B,MAAM,OAAO,EAAE;AACf,QAAQ,8BAA8B,EAAE,4BAA4B;AACpE,QAAQ,6BAA6B,EAAE;AACvC;AACA,KAAK,CAAC;AACN;AACA,EAAE,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,6BAA6B,EAAE,GAAG,CAAC;AAC1D,EAAE,OAAO,QAAQ;AACjB;;;;"}