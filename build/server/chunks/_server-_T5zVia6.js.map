{"version":3,"file":"_server-_T5zVia6.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/_site_/_server.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport { s as supabase_admin } from \"../../../../chunks/admin.js\";\nasync function page_search(url, site_url) {\n  const options = {\n    range: \"0,9\",\n    // from,to # https://supabase.com/docs/reference/javascript/range\n    search: \"\"\n  };\n  for (const p of url.searchParams) {\n    if (options.hasOwnProperty(p[0])) {\n      options[p[0]] = p[1];\n    }\n  }\n  if (!options.search) {\n    return json({\n      error: \"The search query cannot be empty\"\n    });\n  } else {\n    const [{ data: pages_data, error }, { count: pages_total }] = await Promise.all([\n      supabase_admin.rpc(\"page_search\", {\n        search_terms: options.search.replaceAll(\" \", \" & \"),\n        site_url\n      }).select(\"id, name, url, created_at\").range(parseInt(options.range.split(\",\")[0]), parseInt(options.range.split(\",\")[1])),\n      supabase_admin.rpc(\n        \"page_search\",\n        {\n          search_terms: options.search.replaceAll(\" \", \" & \"),\n          site_url\n        },\n        { count: \"exact\", head: true }\n      )\n    ]);\n    if (error) {\n      return json({\n        error: `The page_search RPC hasn't been added`\n      });\n    }\n    const pages = pages_data?.map((page) => ({\n      _meta: {\n        id: page.id,\n        name: page.name,\n        url: \"/\" + page.url,\n        created_at: page.created_at\n      }\n    }));\n    return json({\n      pages,\n      pages_total\n    });\n  }\n}\nasync function GET({ url, params }) {\n  if (url.searchParams.has(\"search\")) {\n    return await page_search(url, params.site);\n  }\n  const [{ data: site_res }, { data: page_res }, { data: subpages_data }, { data: sections_res }] = await Promise.all([\n    supabase_admin.from(\"sites\").select().filter(\"url\", \"eq\", params.site).single(),\n    supabase_admin.from(\"pages\").select(\"*, site!inner(url)\").match({ url: \"index\", \"site.url\": params.site }).single(),\n    supabase_admin.from(\"pages\").select(\"*, site!inner(url)\").match({ \"site.url\": params.site }),\n    supabase_admin.from(\"sections\").select(\"*, page!inner( site!inner(url) )\").match({\n      \"page.site.url\": params.site,\n      \"page.url\": \"index\"\n    })\n  ]);\n  const site = {\n    ...site_res[\"content\"][\"en\"],\n    _meta: {\n      id: site_res.id,\n      name: site_res.name,\n      url: site_res.url,\n      created_at: site_res.created_at\n    }\n  };\n  const page = {\n    ...page_res[\"content\"][\"en\"],\n    _meta: {\n      id: page_res.id,\n      name: page_res.name,\n      url: page_res.url,\n      created_at: page_res.created_at,\n      // filtering here because the query above is not filtering properly (maybe a Supabase bug)\n      subpages: subpages_data?.filter((subpage) => subpage.parent === null && subpage.url !== \"index\").map((subpage) => ({\n        id: subpage.id,\n        name: subpage.name,\n        url: subpage.url,\n        created_at: subpage.created_at\n      }))\n    }\n  };\n  const sections = sections_res?.sort((a, b) => a.index - b.index).map((section) => ({\n    ...section.content.en,\n    _meta: {\n      id: section.id,\n      symbol: section.symbol,\n      created_at: section.created_at\n    }\n  }));\n  return json({\n    site,\n    page,\n    sections\n  });\n}\nexport {\n  GET\n};\n//# sourceMappingURL=_server.js.map\n"],"names":[],"mappings":";;;;;AAEA,eAAe,WAAW,CAAC,GAAG,EAAE,QAAQ,EAAE;AAC1C,EAAE,MAAM,OAAO,GAAG;AAClB,IAAI,KAAK,EAAE,KAAK;AAChB;AACA,IAAI,MAAM,EAAE;AACZ,GAAG;AACH,EAAE,KAAK,MAAM,CAAC,IAAI,GAAG,CAAC,YAAY,EAAE;AACpC,IAAI,IAAI,OAAO,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE;AACtC,MAAM,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;AAC1B;AACA;AACA,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;AACvB,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,KAAK,EAAE;AACb,KAAK,CAAC;AACN,GAAG,MAAM;AACT,IAAI,MAAM,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,KAAK,EAAE,WAAW,EAAE,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;AACpF,MAAM,cAAc,CAAC,GAAG,CAAC,aAAa,EAAE;AACxC,QAAQ,YAAY,EAAE,OAAO,CAAC,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE,KAAK,CAAC;AAC3D,QAAQ;AACR,OAAO,CAAC,CAAC,MAAM,CAAC,2BAA2B,CAAC,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AAChI,MAAM,cAAc,CAAC,GAAG;AACxB,QAAQ,aAAa;AACrB,QAAQ;AACR,UAAU,YAAY,EAAE,OAAO,CAAC,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE,KAAK,CAAC;AAC7D,UAAU;AACV,SAAS;AACT,QAAQ,EAAE,KAAK,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI;AACpC;AACA,KAAK,CAAC;AACN,IAAI,IAAI,KAAK,EAAE;AACf,MAAM,OAAO,IAAI,CAAC;AAClB,QAAQ,KAAK,EAAE,CAAC,qCAAqC;AACrD,OAAO,CAAC;AACR;AACA,IAAI,MAAM,KAAK,GAAG,UAAU,EAAE,GAAG,CAAC,CAAC,IAAI,MAAM;AAC7C,MAAM,KAAK,EAAE;AACb,QAAQ,EAAE,EAAE,IAAI,CAAC,EAAE;AACnB,QAAQ,IAAI,EAAE,IAAI,CAAC,IAAI;AACvB,QAAQ,GAAG,EAAE,GAAG,GAAG,IAAI,CAAC,GAAG;AAC3B,QAAQ,UAAU,EAAE,IAAI,CAAC;AACzB;AACA,KAAK,CAAC,CAAC;AACP,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,KAAK;AACX,MAAM;AACN,KAAK,CAAC;AACN;AACA;AACA,eAAe,GAAG,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,EAAE;AACpC,EAAE,IAAI,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;AACtC,IAAI,OAAO,MAAM,WAAW,CAAC,GAAG,EAAE,MAAM,CAAC,IAAI,CAAC;AAC9C;AACA,EAAE,MAAM,CAAC,EAAE,IAAI,EAAE,QAAQ,EAAE,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,EAAE,EAAE,IAAI,EAAE,aAAa,EAAE,EAAE,EAAE,IAAI,EAAE,YAAY,EAAE,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;AACtH,IAAI,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,EAAE,CAAC,MAAM,CAAC,KAAK,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE;AACnF,IAAI,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,OAAO,EAAE,UAAU,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,EAAE;AACvH,IAAI,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC,KAAK,CAAC,EAAE,UAAU,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC;AAChG,IAAI,cAAc,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC,kCAAkC,CAAC,CAAC,KAAK,CAAC;AACrF,MAAM,eAAe,EAAE,MAAM,CAAC,IAAI;AAClC,MAAM,UAAU,EAAE;AAClB,KAAK;AACL,GAAG,CAAC;AACJ,EAAE,MAAM,IAAI,GAAG;AACf,IAAI,GAAG,QAAQ,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC;AAChC,IAAI,KAAK,EAAE;AACX,MAAM,EAAE,EAAE,QAAQ,CAAC,EAAE;AACrB,MAAM,IAAI,EAAE,QAAQ,CAAC,IAAI;AACzB,MAAM,GAAG,EAAE,QAAQ,CAAC,GAAG;AACvB,MAAM,UAAU,EAAE,QAAQ,CAAC;AAC3B;AACA,GAAG;AACH,EAAE,MAAM,IAAI,GAAG;AACf,IAAI,GAAG,QAAQ,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC;AAChC,IAAI,KAAK,EAAE;AACX,MAAM,EAAE,EAAE,QAAQ,CAAC,EAAE;AACrB,MAAM,IAAI,EAAE,QAAQ,CAAC,IAAI;AACzB,MAAM,GAAG,EAAE,QAAQ,CAAC,GAAG;AACvB,MAAM,UAAU,EAAE,QAAQ,CAAC,UAAU;AACrC;AACA,MAAM,QAAQ,EAAE,aAAa,EAAE,MAAM,CAAC,CAAC,OAAO,KAAK,OAAO,CAAC,MAAM,KAAK,IAAI,IAAI,OAAO,CAAC,GAAG,KAAK,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,OAAO,MAAM;AACzH,QAAQ,EAAE,EAAE,OAAO,CAAC,EAAE;AACtB,QAAQ,IAAI,EAAE,OAAO,CAAC,IAAI;AAC1B,QAAQ,GAAG,EAAE,OAAO,CAAC,GAAG;AACxB,QAAQ,UAAU,EAAE,OAAO,CAAC;AAC5B,OAAO,CAAC;AACR;AACA,GAAG;AACH,EAAE,MAAM,QAAQ,GAAG,YAAY,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,CAAC,OAAO,MAAM;AACrF,IAAI,GAAG,OAAO,CAAC,OAAO,CAAC,EAAE;AACzB,IAAI,KAAK,EAAE;AACX,MAAM,EAAE,EAAE,OAAO,CAAC,EAAE;AACpB,MAAM,MAAM,EAAE,OAAO,CAAC,MAAM;AAC5B,MAAM,UAAU,EAAE,OAAO,CAAC;AAC1B;AACA,GAAG,CAAC,CAAC;AACL,EAAE,OAAO,IAAI,CAAC;AACd,IAAI,IAAI;AACR,IAAI,IAAI;AACR,IAAI;AACJ,GAAG,CAAC;AACJ;;;;"}