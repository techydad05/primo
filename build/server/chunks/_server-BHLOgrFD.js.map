{"version":3,"file":"_server-BHLOgrFD.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/_site_/_...page_/_server.js"],"sourcesContent":["import { j as json } from \"../../../../../chunks/index.js\";\nimport { s as supabase_admin } from \"../../../../../chunks/admin.js\";\nimport { l as languages } from \"../../../../../chunks/Page.svelte_svelte_type_style_lang.js\";\nimport \"../../../../../chunks/Icon.js\";\nimport \"mousetrap\";\nimport \"axios\";\nimport \"file-saver\";\nimport \"autosize\";\nasync function GET({ url, params }) {\n  const pages = params.page?.split(\"/\") || [];\n  const lang = languages.some((lang2) => lang2.key === pages[0]) ? pages.pop() : \"en\";\n  const page_url = pages.pop() || \"index\";\n  const parent_url = pages.pop() || null;\n  const options = {\n    format: \"html\",\n    // html | markdown\n    range: \"0,9\",\n    // from,to # https://supabase.com/docs/reference/javascript/range\n    sort: \"created_at,desc\",\n    // created_at | name, asc | desc  # default returns latest\n    sections: \"*\"\n    // limit the results to specific comma separated section ids\n  };\n  for (const p of url.searchParams) {\n    if (options.hasOwnProperty(p[0])) {\n      options[p[0]] = p[1];\n    } else {\n      return json({ error: `${p[0]} isn't a valid query parameter` });\n    }\n  }\n  const [\n    { data: site_data },\n    { data: page_data },\n    { data: subpages_data },\n    { count: subpages_total },\n    { data: sections_data }\n  ] = await Promise.all([\n    supabase_admin.from(\"sites\").select().filter(\"url\", \"eq\", params.site).single(),\n    supabase_admin.from(\"pages\").select(\"*, site!inner(url)\").match({ url: page_url, \"site.url\": params.site }).single(),\n    supabase_admin.from(\"pages\").select(\"*, parent!inner(*), site!inner(url)\").match({ \"site.url\": params.site, \"parent.url\": page_url }).order(options.sort.split(\",\")[0], {\n      ascending: options.sort.split(\",\")[1] === \"asc\"\n    }).range(parseInt(options.range.split(\",\")[0]), parseInt(options.range.split(\",\")[1])),\n    supabase_admin.from(\"pages\").select(\"*, parent!inner(url), site!inner(url)\", {\n      count: \"exact\",\n      head: true\n    }).match({ \"site.url\": params.site, \"parent.url\": page_url }),\n    options.sections === \"*\" ? supabase_admin.from(\"sections\").select(\n      parent_url ? `*, symbol(name, content), page!inner( url, site!inner(url), parent!inner(url) )` : `*, symbol(name, content), page!inner( url, site!inner(url) )`\n    ).match({\n      \"page.url\": page_url,\n      \"page.site.url\": params.site,\n      ...parent_url ? { \"page.parent.url\": parent_url } : {}\n    }).order(\"index\") : supabase_admin.from(\"sections\").select(\n      parent_url ? `*, symbol(name, content), page!inner( url, site!inner(url), parent!inner(url) )` : `*, poo:content->en, symbol(name, content), page!inner( url, site!inner(url) )`\n    ).match({\n      \"page.url\": page_url,\n      \"page.site.url\": params.site,\n      ...parent_url ? { \"page.parent.url\": parent_url } : {}\n    }).in(\"id\", options.sections.split(\",\")).order(\"index\")\n  ]);\n  const site = {\n    // @ts-ignore\n    ...site_data[\"content\"][lang],\n    _meta: {\n      id: site_data.id,\n      name: site_data.name,\n      url: site_data.url,\n      created_at: site_data.created_at\n    }\n  };\n  const page = {\n    // @ts-ignore\n    ...page_data[\"content\"][lang],\n    _meta: {\n      id: page_data.id,\n      name: page_data.name,\n      url: page_data.url,\n      created_at: page_data.created_at,\n      subpages_total,\n      subpages: subpages_data?.map((subpage) => ({\n        id: subpage.id,\n        name: subpage.name,\n        url: subpage.url,\n        created_at: subpage.created_at\n      }))\n    }\n  };\n  format_markdown_content(sections_data, options.format);\n  const sections = sections_data?.map((section) => ({\n    // @ts-ignore\n    ...section.symbol[\"content\"][lang],\n    // static field values\n    // @ts-ignore\n    ...section[\"content\"][lang],\n    // dynamic field values overwrite if they exist\n    _meta: {\n      id: section.id,\n      symbol: section.symbol.id,\n      name: section.symbol.name,\n      created_at: section.created_at\n    }\n  }));\n  console.log({ sections_data });\n  return json({\n    site,\n    page,\n    sections\n  });\n}\nfunction format_markdown_content(sections, format) {\n  if (Array.isArray(sections)) {\n    sections.forEach((item) => format_markdown_content(item, format));\n  } else if (typeof sections === \"object\" && sections !== null) {\n    Object.keys(sections).forEach((key) => {\n      if (typeof sections[key] === \"object\" && sections[key] !== null && sections.hasOwnProperty(key)) {\n        if (sections[key].hasOwnProperty(\"html\") && sections[key].hasOwnProperty(\"markdown\") && Object.keys(sections[key]).length === 2) {\n          if (format) {\n            delete sections[key][\"markdown\"];\n          } else {\n            delete sections[key][\"html\"];\n          }\n        } else {\n          format_markdown_content(sections[key], format);\n        }\n      }\n    });\n  }\n}\nexport {\n  GET\n};\n//# sourceMappingURL=_server.js.map\n"],"names":[],"mappings":"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"}