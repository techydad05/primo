{"version":3,"file":"_server-CkWlfD7i.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/deploy/_server.js"],"sourcesContent":["import { e as error, j as json } from \"../../../../chunks/index.js\";\nimport { s as supabase_admin } from \"../../../../chunks/admin.js\";\nimport axios from \"axios\";\nasync function POST({ request, locals }) {\n  const session = await locals.getSession();\n  if (!session) {\n    throw error(401, { message: \"Unauthorized\" });\n  }\n  const { files, site_id, repo_name, create_new, message, provider } = await request.json();\n  const user_id = session.user.id;\n  const [{ data: collaborator }, { data: server_member }] = await Promise.all([\n    supabase_admin.from(\"collaborators\").select(\"*\").match({ site: site_id, user: user_id }).single(),\n    supabase_admin.from(\"server_members\").select(\"*\").eq(\"user\", user_id).single()\n  ]);\n  if (collaborator || server_member) {\n    const { data: token } = await supabase_admin.from(\"config\").select(\"value\").eq(\"id\", `${provider}_token`).single();\n    if (!token) {\n      return json({ deployment: null, error: \"No token found\" });\n    }\n    if (create_new) {\n      const new_deployment = await git_providers[provider].create_repo({\n        repo_name,\n        token: token.value\n      });\n      return json({ deployment: new_deployment, error: null });\n    } else {\n      const new_deployment = await git_providers[provider].push_site({\n        files,\n        token: token.value,\n        repo_name,\n        message\n      });\n      await supabase_admin.from(\"sites\").update({ active_deployment: new_deployment }).eq(\"id\", site_id);\n      return json({ deployment: new_deployment, error: null });\n    }\n  } else {\n    return json({ deployment: null, error: \"Unauthorized\" });\n  }\n}\nconst github = {\n  /**\n   * @param {CreateRepoParams} params\n   * @returns {Promise<void>}\n   */\n  create_repo: async function({ repo_name, token }) {\n    const repo_sans_user = repo_name.split(\"/\")[1];\n    const { data } = await axios.post(\n      `https://api.github.com/user/repos`,\n      {\n        name: repo_sans_user,\n        auto_init: true\n      },\n      { headers: { Authorization: `Bearer ${token}` } }\n    );\n    return data;\n  },\n  /**\n   * @param {PushSiteParams} params\n   * @returns {Promise<import('@primocms/builder/src/lib/deploy.js').DeploymentResponse>}\n   */\n  push_site: async function({ repo_name, files, message, token }) {\n    const headers = {\n      Authorization: `Bearer ${token}`,\n      Accept: \"application/vnd.github.v3+json\"\n    };\n    const [\n      { data: existing_repo },\n      {\n        data: [latest_commit]\n      }\n    ] = await Promise.all([\n      axios.get(`https://api.github.com/repos/${repo_name}`, { headers }),\n      axios.get(`https://api.github.com/repos/${repo_name}/commits?sha=main`, {\n        headers\n      })\n    ]);\n    const active_sha = latest_commit?.sha;\n    const tree = await create_tree();\n    const commit = await create_commit(tree.sha, active_sha);\n    const final = await push_commit(commit.sha);\n    return {\n      deploy_id: final.object.sha,\n      repo: existing_repo,\n      created: Date.now(),\n      tree\n    };\n    async function create_tree() {\n      const tree2 = files.map((file) => ({\n        path: file.path,\n        sha: file.sha,\n        type: \"blob\",\n        mode: \"100644\"\n      }));\n      const { data } = await axios.post(\n        `https://api.github.com/repos/${repo_name}/git/trees`,\n        { tree: tree2 },\n        { headers }\n      );\n      return data;\n    }\n    async function create_commit(tree2, active_sha2) {\n      const { data } = await axios.post(\n        `https://api.github.com/repos/${repo_name}/git/commits`,\n        {\n          message,\n          tree: tree2,\n          ...active_sha2 ? { parents: [active_sha2] } : {}\n        },\n        { headers }\n      );\n      return data;\n    }\n    async function push_commit(commitSha) {\n      const { data } = await axios.patch(\n        `https://api.github.com/repos/${repo_name}/git/refs/heads/main`,\n        {\n          sha: commitSha\n          // force: true,\n        },\n        { headers }\n      );\n      return data;\n    }\n  }\n};\nconst gitlab = {\n  /**\n   * @param {CreateRepoParams} params\n   * @returns {Promise<void>}\n   */\n  create_repo: async function({ repo_name, token }) {\n    const repo_sans_user = repo_name.split(\"/\")[1];\n    const response = await axios.post(\n      `https://gitlab.com/api/v4/projects`,\n      { name: repo_sans_user, initialize_with_readme: true },\n      { headers: { \"PRIVATE-TOKEN\": token } }\n    );\n    console.log(\"Repository created:\", response.data);\n  },\n  /**\n   * @param {PushSiteParams} params\n   * @returns {Promise<import('@primocms/builder/src/lib/deploy.js').DeploymentResponse>}\n   */\n  push_site: async function({ repo_name, files, message, token }) {\n    const project_id = encodeURIComponent(repo_name);\n    const headers = { \"PRIVATE-TOKEN\": token };\n    const existing_files = await fetch_file_list(project_id);\n    const actions = files.map((file) => ({\n      action: existing_files.includes(file.path) ? \"update\" : \"create\",\n      file_path: file.path,\n      content: file.content\n    }));\n    const { data } = await axios.post(\n      `https://gitlab.com/api/v4/projects/${project_id}/repository/commits`,\n      { branch: \"main\", commit_message: message, actions },\n      { headers }\n    );\n    console.log(\"Commit successful:\", data);\n    return {\n      deploy_id: data.id,\n      repo: {\n        ...data,\n        full_name: repo_name\n        // copy github response for later display\n      },\n      created: Date.now()\n    };\n    async function fetch_file_list(project_id2) {\n      const fileList = await fetch_tree_files(\n        `https://gitlab.com/api/v4/projects/${project_id2}/repository/tree`\n      );\n      return fileList;\n      async function fetch_tree_files(url) {\n        const response = await axios.get(url, { headers });\n        const items = response.data;\n        const filePromises = items.map(async (item) => {\n          if (item.type === \"blob\") {\n            return item.path;\n          } else if (item.type === \"tree\") {\n            const subUrl = `https://gitlab.com/api/v4/projects/${project_id2}/repository/tree?path=${encodeURIComponent(\n              item.path\n            )}`;\n            const subFiles = await fetch_tree_files(subUrl);\n            return subFiles;\n          }\n        });\n        return (await Promise.all(filePromises)).flat();\n      }\n    }\n  }\n};\nconst git_providers = {\n  github,\n  gitlab\n};\nexport {\n  POST\n};\n//# sourceMappingURL=_server.js.map\n"],"names":[],"mappings":";;;;;;AAGA,eAAe,IAAI,CAAC,EAAE,OAAO,EAAE,MAAM,EAAE,EAAE;AACzC,EAAE,MAAM,OAAO,GAAG,MAAM,MAAM,CAAC,UAAU,EAAE;AAC3C,EAAE,IAAI,CAAC,OAAO,EAAE;AAChB,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC;AACjD;AACA,EAAE,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,SAAS,EAAE,UAAU,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE;AAC3F,EAAE,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,CAAC,EAAE;AACjC,EAAE,MAAM,CAAC,EAAE,IAAI,EAAE,YAAY,EAAE,EAAE,EAAE,IAAI,EAAE,aAAa,EAAE,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;AAC9E,IAAI,cAAc,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC,MAAM,EAAE;AACrG,IAAI,cAAc,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,MAAM;AAChF,GAAG,CAAC;AACJ,EAAE,IAAI,YAAY,IAAI,aAAa,EAAE;AACrC,IAAI,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,IAAI,EAAE,CAAC,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,EAAE;AACtH,IAAI,IAAI,CAAC,KAAK,EAAE;AAChB,MAAM,OAAO,IAAI,CAAC,EAAE,UAAU,EAAE,IAAI,EAAE,KAAK,EAAE,gBAAgB,EAAE,CAAC;AAChE;AACA,IAAI,IAAI,UAAU,EAAE;AACpB,MAAM,MAAM,cAAc,GAAG,MAAM,aAAa,CAAC,QAAQ,CAAC,CAAC,WAAW,CAAC;AACvE,QAAQ,SAAS;AACjB,QAAQ,KAAK,EAAE,KAAK,CAAC;AACrB,OAAO,CAAC;AACR,MAAM,OAAO,IAAI,CAAC,EAAE,UAAU,EAAE,cAAc,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC;AAC9D,KAAK,MAAM;AACX,MAAM,MAAM,cAAc,GAAG,MAAM,aAAa,CAAC,QAAQ,CAAC,CAAC,SAAS,CAAC;AACrE,QAAQ,KAAK;AACb,QAAQ,KAAK,EAAE,KAAK,CAAC,KAAK;AAC1B,QAAQ,SAAS;AACjB,QAAQ;AACR,OAAO,CAAC;AACR,MAAM,MAAM,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,EAAE,iBAAiB,EAAE,cAAc,EAAE,CAAC,CAAC,EAAE,CAAC,IAAI,EAAE,OAAO,CAAC;AACxG,MAAM,OAAO,IAAI,CAAC,EAAE,UAAU,EAAE,cAAc,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC;AAC9D;AACA,GAAG,MAAM;AACT,IAAI,OAAO,IAAI,CAAC,EAAE,UAAU,EAAE,IAAI,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC;AAC5D;AACA;AACA,MAAM,MAAM,GAAG;AACf;AACA;AACA;AACA;AACA,EAAE,WAAW,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE;AACpD,IAAI,MAAM,cAAc,GAAG,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;AAClD,IAAI,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,KAAK,CAAC,IAAI;AACrC,MAAM,CAAC,iCAAiC,CAAC;AACzC,MAAM;AACN,QAAQ,IAAI,EAAE,cAAc;AAC5B,QAAQ,SAAS,EAAE;AACnB,OAAO;AACP,MAAM,EAAE,OAAO,EAAE,EAAE,aAAa,EAAE,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC,EAAE;AACrD,KAAK;AACL,IAAI,OAAO,IAAI;AACf,GAAG;AACH;AACA;AACA;AACA;AACA,EAAE,SAAS,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,OAAO,EAAE,KAAK,EAAE,EAAE;AAClE,IAAI,MAAM,OAAO,GAAG;AACpB,MAAM,aAAa,EAAE,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;AACtC,MAAM,MAAM,EAAE;AACd,KAAK;AACL,IAAI,MAAM;AACV,MAAM,EAAE,IAAI,EAAE,aAAa,EAAE;AAC7B,MAAM;AACN,QAAQ,IAAI,EAAE,CAAC,aAAa;AAC5B;AACA,KAAK,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;AAC1B,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,6BAA6B,EAAE,SAAS,CAAC,CAAC,EAAE,EAAE,OAAO,EAAE,CAAC;AACzE,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,6BAA6B,EAAE,SAAS,CAAC,iBAAiB,CAAC,EAAE;AAC9E,QAAQ;AACR,OAAO;AACP,KAAK,CAAC;AACN,IAAI,MAAM,UAAU,GAAG,aAAa,EAAE,GAAG;AACzC,IAAI,MAAM,IAAI,GAAG,MAAM,WAAW,EAAE;AACpC,IAAI,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,IAAI,CAAC,GAAG,EAAE,UAAU,CAAC;AAC5D,IAAI,MAAM,KAAK,GAAG,MAAM,WAAW,CAAC,MAAM,CAAC,GAAG,CAAC;AAC/C,IAAI,OAAO;AACX,MAAM,SAAS,EAAE,KAAK,CAAC,MAAM,CAAC,GAAG;AACjC,MAAM,IAAI,EAAE,aAAa;AACzB,MAAM,OAAO,EAAE,IAAI,CAAC,GAAG,EAAE;AACzB,MAAM;AACN,KAAK;AACL,IAAI,eAAe,WAAW,GAAG;AACjC,MAAM,MAAM,KAAK,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,MAAM;AACzC,QAAQ,IAAI,EAAE,IAAI,CAAC,IAAI;AACvB,QAAQ,GAAG,EAAE,IAAI,CAAC,GAAG;AACrB,QAAQ,IAAI,EAAE,MAAM;AACpB,QAAQ,IAAI,EAAE;AACd,OAAO,CAAC,CAAC;AACT,MAAM,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,KAAK,CAAC,IAAI;AACvC,QAAQ,CAAC,6BAA6B,EAAE,SAAS,CAAC,UAAU,CAAC;AAC7D,QAAQ,EAAE,IAAI,EAAE,KAAK,EAAE;AACvB,QAAQ,EAAE,OAAO;AACjB,OAAO;AACP,MAAM,OAAO,IAAI;AACjB;AACA,IAAI,eAAe,aAAa,CAAC,KAAK,EAAE,WAAW,EAAE;AACrD,MAAM,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,KAAK,CAAC,IAAI;AACvC,QAAQ,CAAC,6BAA6B,EAAE,SAAS,CAAC,YAAY,CAAC;AAC/D,QAAQ;AACR,UAAU,OAAO;AACjB,UAAU,IAAI,EAAE,KAAK;AACrB,UAAU,GAAG,WAAW,GAAG,EAAE,OAAO,EAAE,CAAC,WAAW,CAAC,EAAE,GAAG;AACxD,SAAS;AACT,QAAQ,EAAE,OAAO;AACjB,OAAO;AACP,MAAM,OAAO,IAAI;AACjB;AACA,IAAI,eAAe,WAAW,CAAC,SAAS,EAAE;AAC1C,MAAM,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,KAAK,CAAC,KAAK;AACxC,QAAQ,CAAC,6BAA6B,EAAE,SAAS,CAAC,oBAAoB,CAAC;AACvE,QAAQ;AACR,UAAU,GAAG,EAAE;AACf;AACA,SAAS;AACT,QAAQ,EAAE,OAAO;AACjB,OAAO;AACP,MAAM,OAAO,IAAI;AACjB;AACA;AACA,CAAC;AACD,MAAM,MAAM,GAAG;AACf;AACA;AACA;AACA;AACA,EAAE,WAAW,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE;AACpD,IAAI,MAAM,cAAc,GAAG,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;AAClD,IAAI,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,IAAI;AACrC,MAAM,CAAC,kCAAkC,CAAC;AAC1C,MAAM,EAAE,IAAI,EAAE,cAAc,EAAE,sBAAsB,EAAE,IAAI,EAAE;AAC5D,MAAM,EAAE,OAAO,EAAE,EAAE,eAAe,EAAE,KAAK,EAAE;AAC3C,KAAK;AACL,IAAI,OAAO,CAAC,GAAG,CAAC,qBAAqB,EAAE,QAAQ,CAAC,IAAI,CAAC;AACrD,GAAG;AACH;AACA;AACA;AACA;AACA,EAAE,SAAS,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,OAAO,EAAE,KAAK,EAAE,EAAE;AAClE,IAAI,MAAM,UAAU,GAAG,kBAAkB,CAAC,SAAS,CAAC;AACpD,IAAI,MAAM,OAAO,GAAG,EAAE,eAAe,EAAE,KAAK,EAAE;AAC9C,IAAI,MAAM,cAAc,GAAG,MAAM,eAAe,CAAC,UAAU,CAAC;AAC5D,IAAI,MAAM,OAAO,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,MAAM;AACzC,MAAM,MAAM,EAAE,cAAc,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,QAAQ,GAAG,QAAQ;AACtE,MAAM,SAAS,EAAE,IAAI,CAAC,IAAI;AAC1B,MAAM,OAAO,EAAE,IAAI,CAAC;AACpB,KAAK,CAAC,CAAC;AACP,IAAI,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,KAAK,CAAC,IAAI;AACrC,MAAM,CAAC,mCAAmC,EAAE,UAAU,CAAC,mBAAmB,CAAC;AAC3E,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,OAAO,EAAE;AAC1D,MAAM,EAAE,OAAO;AACf,KAAK;AACL,IAAI,OAAO,CAAC,GAAG,CAAC,oBAAoB,EAAE,IAAI,CAAC;AAC3C,IAAI,OAAO;AACX,MAAM,SAAS,EAAE,IAAI,CAAC,EAAE;AACxB,MAAM,IAAI,EAAE;AACZ,QAAQ,GAAG,IAAI;AACf,QAAQ,SAAS,EAAE;AACnB;AACA,OAAO;AACP,MAAM,OAAO,EAAE,IAAI,CAAC,GAAG;AACvB,KAAK;AACL,IAAI,eAAe,eAAe,CAAC,WAAW,EAAE;AAChD,MAAM,MAAM,QAAQ,GAAG,MAAM,gBAAgB;AAC7C,QAAQ,CAAC,mCAAmC,EAAE,WAAW,CAAC,gBAAgB;AAC1E,OAAO;AACP,MAAM,OAAO,QAAQ;AACrB,MAAM,eAAe,gBAAgB,CAAC,GAAG,EAAE;AAC3C,QAAQ,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,OAAO,EAAE,CAAC;AAC1D,QAAQ,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI;AACnC,QAAQ,MAAM,YAAY,GAAG,KAAK,CAAC,GAAG,CAAC,OAAO,IAAI,KAAK;AACvD,UAAU,IAAI,IAAI,CAAC,IAAI,KAAK,MAAM,EAAE;AACpC,YAAY,OAAO,IAAI,CAAC,IAAI;AAC5B,WAAW,MAAM,IAAI,IAAI,CAAC,IAAI,KAAK,MAAM,EAAE;AAC3C,YAAY,MAAM,MAAM,GAAG,CAAC,mCAAmC,EAAE,WAAW,CAAC,sBAAsB,EAAE,kBAAkB;AACvH,cAAc,IAAI,CAAC;AACnB,aAAa,CAAC,CAAC;AACf,YAAY,MAAM,QAAQ,GAAG,MAAM,gBAAgB,CAAC,MAAM,CAAC;AAC3D,YAAY,OAAO,QAAQ;AAC3B;AACA,SAAS,CAAC;AACV,QAAQ,OAAO,CAAC,MAAM,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,IAAI,EAAE;AACvD;AACA;AACA;AACA,CAAC;AACD,MAAM,aAAa,GAAG;AACtB,EAAE,MAAM;AACR,EAAE;AACF,CAAC;;;;"}